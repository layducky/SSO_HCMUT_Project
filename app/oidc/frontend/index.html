<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>OIDC SPA Frontend</title>
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect } = React;

function App() {
  const [user, setUser] = useState(null);
  const [error, setError] = useState(null);
  
  useEffect(() => {
    const params = new URLSearchParams(window.location.search);
    
    if (params.get('logged_in')) {
      fetch('http://localhost:8081/user', { credentials: 'include' })
        .then(res => res.ok ? res.json() : Promise.reject('Failed'))
        .then(data => setUser(data.user))
        .catch(() => setError('Login failed'));
      window.history.replaceState({}, '', '/');
    }
    
    if (params.get('error')) {
      setError(params.get('error_description') || 'Login failed');
      window.history.replaceState({}, '', '/');
    }
  }, []);
  
  const handleLogout = async () => {
    await fetch('http://localhost:8081/logout', { method: 'POST', credentials: 'include' });
    setUser(null);
  };
  
  return (
    <div style={{ textAlign: 'center', marginTop: '50px' }}>
      <h2>OIDC SPA Demo</h2>
      {error && <p style={{color: 'red'}}>{error}</p>}
      {!user ? (
        <button onClick={() => window.location.href = 'http://localhost:8081/login'}>Login</button>
      ) : (
        <div>
          <p>Welcome, {user.name || user.preferred_username}</p>
          <p>Email: {user.email}</p>
          <button onClick={handleLogout}>Logout</button>
        </div>
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>