<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>App 2 - CAS SSO Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            color: #333;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>App 2 - CAS SSO Demo</h1>
        <div id="content">
            <p>Checking login status...</p>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8082';
        
        function checkAuth() {
            fetch(API_BASE_URL + '/auth/status', { 
                credentials: 'include' 
            })
            .then(response => {
                if (!response.ok) throw new Error('HTTP error: ' + response.status);
                return response.json();
            })
            .then(data => {
                const content = document.getElementById('content');
                
                if (data.authenticated) {
                    content.innerHTML = `
                        <div class="success">
                            <h2>LOGIN AUTOMATICALLY!</h2>
                            <p><strong>This is Single Sign-On in action!</strong></p>
                        </div>
                        <h3>User Information:</h3>
                        <p><strong>Username:</strong> ${data.user.username}</p>
                        <p><strong>Email:</strong> ${data.user.email}</p>
                        <p><strong>ID:</strong> ${data.user.id}</p>
                        
                        <button onclick="fetchProtectedData()">Get Protected Data</button>
                        <button onclick="logout()">Logout</button>
                        
                        <div id="api-response" style="margin-top: 20px;"></div>
                    `;
                } else {
                    content.innerHTML = `
                        <div class="error">
                            <h2>Not logged in</h2>
                            <p><strong>Please login at App 1 first:</strong></p>
                            <a href="http://localhost:3002" target="_blank" style="color: #667eea; font-weight: bold;">
                                http://localhost:3002
                            </a>
                            <p>After logging in at App 1, refresh this page to see the magic! âœ¨</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Connection error:', error);
                const content = document.getElementById('content');
                content.innerHTML = `
                    <div class="error">
                        <h2>Connection Error</h2>
                        <p>API URL: ${API_BASE_URL}</p>
                        <p>Error: ${error.message}</p>
                        <button onclick="testBackend()">Test Backend</button>
                    </div>
                `;
            });
        }

        function testBackend() {
            fetch(API_BASE_URL + '/health')
                .then(response => response.json())
                .then(data => {
                    alert('Backend OK: ' + JSON.stringify(data));
                })
                .catch(err => {
                    alert('Backend ERROR: ' + err.message);
                });
        }

        function fetchProtectedData() {
            fetch(API_BASE_URL + '/api/protected-data', { 
                credentials: 'include' 
            })
            .then(response => response.json())
            .then(data => {
                const responseDiv = document.getElementById('api-response');
                responseDiv.innerHTML = `
                    <h4>Protected Data from App 2:</h4>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
            })
            .catch(error => {
                const responseDiv = document.getElementById('api-response');
                responseDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            });
        }

        function logout() {
            fetch(API_BASE_URL + '/auth/logout', { 
                method: 'POST',
                credentials: 'include' 
            })
            .then(() => {
                alert('Logged out!');
                location.reload();
            });
        }

        // Check auth when page loads
        document.addEventListener('DOMContentLoaded', checkAuth);
    </script>
</body>
</html>